"use strict";(self.webpackChunkapp=self.webpackChunkapp||[]).push([[4305],{4305:(x,h,n)=>{n.r(h),n.d(h,{PasajeroPageModule:()=>C});var d=n(177),f=n(4341),o=n(4742),m=n(9384),p=n(467),e=n(3953),v=n(8079),g=n(9011),j=n(7770),b=n(6378);function I(i,E){if(1&i){const r=e.RV6();e.j41(0,"ion-item",4)(1,"ion-card",5)(2,"h2"),e.EFF(3),e.k0s(),e.j41(4,"p"),e.EFF(5),e.k0s(),e.j41(6,"p"),e.EFF(7),e.k0s(),e.j41(8,"p"),e.EFF(9),e.nrm(10,"ion-icon",6),e.k0s(),e.j41(11,"p"),e.nrm(12,"ion-icon",7),e.EFF(13),e.nI1(14,"date"),e.k0s(),e.j41(15,"p"),e.nrm(16,"ion-icon",8),e.EFF(17),e.nI1(18,"date"),e.k0s(),e.nrm(19,"div",9),e.j41(20,"ion-button",10),e.bIt("click",function(){const t=e.eBV(r).$implicit,s=e.XpG();return e.Njj(s.reservarAsiento(t,t.id.toString(),t.capacidad,t.usuarioId))}),e.nrm(21,"ion-icon",11),e.EFF(22," Reservar Asiento "),e.k0s(),e.j41(23,"ion-button",12),e.bIt("click",function(){const t=e.eBV(r).$implicit,s=e.XpG();return e.Njj(s.eliminarReserva(t.id.toString(),t.capacidad,t.usuarioId))}),e.nrm(24,"ion-icon",13),e.EFF(25," Eliminar Reserva "),e.k0s()()()}if(2&i){const r=E.$implicit,a=e.XpG();e.R7$(3),e.JRh(r.destino),e.R7$(2),e.JRh(r.nombreCreador),e.R7$(2),e.SpI("Capacidad disponible: ",r.capacidad," personas"),e.R7$(2),e.SpI("Costo: $",r.costo," - "),e.R7$(4),e.SpI("",e.i5U(14,10,r.horaSalida,"dd/MM/yyyy")," "),e.R7$(4),e.JRh(e.i5U(18,13,r.horaSalida,"HH:mm")),e.R7$(2),e.Mz_("id","map-",r.id,""),e.R7$(),e.Y8G("disabled",a.reserva),e.R7$(3),e.Y8G("disabled",a.EliminarReserva)}}const P=[{path:"",component:(()=>{class i{constructor(r,a,t,s,c){this.alert=r,this.firestore=a,this.databaseService=t,this.mapsService=s,this.authService=c,this.viajes=[],this.reserva=!1,this.EliminarReserva=!0,this.currentUserId="",this.currentUserName=""}ngOnInit(){this.authService.getUser().subscribe({next:r=>{r&&(this.currentUserId=r.uid,this.currentUserName="",this.cargarViajes())},error:r=>{console.error("Error al obtener el usuario:",r)}}),this.initCurrentLocation(),this.databaseService.obtenerNombreUsuarioActual().subscribe({next:r=>{this.currentUserName=r,console.log("Nombre del usuario:",this.currentUserName)},error:r=>{console.error("Error al obtener el nombre del usuario:",r)}})}cargarViajes(){this.firestore.collection("viajes").valueChanges().subscribe(r=>{this.viajes=r.filter(a=>a.usuarioId!==this.currentUserId),this.refreshMaps()})}refreshMaps(){this.mapsService.refreshMaps(this.viajes,this.currentLocation)}initCurrentLocation(){var r=this;return(0,p.A)(function*(){try{r.currentLocation=yield r.mapsService.getCurrentLocation(),r.mapsService.refreshMaps(r.viajes,r.currentLocation)}catch(a){console.error("Error al obtener la geolocalizaci\xf3n:",a)}})()}reservarAsiento(r,a,t,s){if(t<=0)return void this.alertas("Error","No hay asientos disponibles.");if(!this.currentUserName)return void this.alertas("Error","No se ha encontrado el nombre del usuario.");this.alertas("Asiento Reservado","Su destino es: "+r.destino),this.reserva=!0,this.EliminarReserva=!1;const c=t-1;this.firestore.collection("viajes").doc(a).update({capacidad:c}).then(()=>{console.log("Capacidad actualizada correctamente.");const l={notificationId:Date.now().toString(),tipo:"Reserva Asiento",mensaje:`El usuario ${this.currentUserName} ha reservado un asiento para el viaje a ${r.destino}.`,fecha:new Date,leido:!1,usuarioId:s,reservaUsuarioId:this.currentUserId,viajeId:a,creadorId:r.usuarioId},u={notificationId:Date.now().toString()+"_user",tipo:"Reserva Asiento",mensaje:`Has reservado un asiento para el viaje a ${r.destino}.`,fecha:new Date,leido:!1,usuarioId:this.currentUserId,reservaUsuarioId:this.currentUserId,viajeId:a,creadorId:r.usuarioId};return Promise.all([this.firestore.collection("notificaciones").add(l),this.firestore.collection("notificaciones").add(u)])}).then(()=>{console.log("Notificaciones agregadas correctamente.")}).catch(l=>{console.error("Error al actualizar la capacidad o agregar las notificaciones: ",l),this.alertas("Error","Hubo un problema al realizar la reserva.")}).finally(()=>{})}eliminarReserva(r,a,t){this.EliminarReserva=!0,this.reserva=!1;const s=a+1;this.firestore.collection("viajes").doc(r).update({capacidad:s}).then(()=>{console.log("Reserva eliminada y capacidad actualizada."),this.firestore.collection("notificaciones",l=>l.where("viajeId","==",r).where("reservaUsuarioId","==",this.currentUserId).where("tipo","==","Reserva Asiento")).get().subscribe(l=>{l.forEach(u=>{u.ref.delete().then(()=>{console.log("Notificaci\xf3n de reserva eliminada.")}).catch(R=>{console.error("Error al eliminar la notificaci\xf3n de reserva:",R)})})});const c={notificationId:Date.now().toString(),tipo:"Cancelaci\xf3n Reserva",mensaje:`El usuario ${this.currentUserName} ha cancelado su reserva para el viaje a ${r}.`,fecha:new Date,leido:!1,usuarioId:t,reservaUsuarioId:this.currentUserId,viajeId:r};return this.firestore.collection("notificaciones").add(c)}).then(()=>{console.log("Notificaci\xf3n de cancelaci\xf3n agregada correctamente.")}).catch(c=>{console.error("Error al eliminar la reserva o crear la notificaci\xf3n de cancelaci\xf3n:",c)})}alertas(r,a){var t=this;return(0,p.A)(function*(){(yield t.alert.create({header:r,message:a,buttons:["Aceptar"]})).present()})()}static{this.\u0275fac=function(a){return new(a||i)(e.rXU(o.hG),e.rXU(v.Qe),e.rXU(g.B),e.rXU(j.D),e.rXU(b.P))}}static{this.\u0275cmp=e.VBU({type:i,selectors:[["app-pasajero"]],decls:13,vars:1,consts:[["color","primary",1,"toolbar-custom"],[1,"viajes-content"],[1,"viaje-card-header"],["class","viaje-item",4,"ngFor","ngForOf"],[1,"viaje-item"],[1,"ion-padding","viaje-info-card"],["slot","start","name","person"],["slot","start","name","calendar-outline"],["slot","start-outline","name","time"],[1,"map-container",3,"id"],["color","primary","fill","outline","expand","block",3,"click","disabled"],["name","checkmark","slot","start"],["expand","block","fill","clear","shape","round","color","danger",3,"click","disabled"],["name","trash","slot","start"]],template:function(a,t){1&a&&(e.j41(0,"ion-header")(1,"ion-toolbar",0)(2,"ion-title"),e.EFF(3,"Solicitar Transporte"),e.k0s()()(),e.j41(4,"ion-content",1)(5,"ion-grid")(6,"ion-row")(7,"ion-col")(8,"ion-card-header",2)(9,"ion-card-title"),e.EFF(10,"Viajes Disponibles"),e.k0s()(),e.j41(11,"ion-list"),e.DNE(12,I,26,16,"ion-item",3),e.k0s()()()()()),2&a&&(e.R7$(12),e.Y8G("ngForOf",t.viajes))},dependencies:[d.Sq,o.Jm,o.b_,o.ME,o.tN,o.hU,o.W9,o.lO,o.eU,o.iq,o.uz,o.nf,o.ln,o.BC,o.ai,d.vh],styles:[".viajes-content[_ngcontent-%COMP%]{background-color:#f2f2f2;padding:15px}.viaje-card-header[_ngcontent-%COMP%]{text-align:center;font-weight:700;font-size:18px;color:#333}.viaje-item[_ngcontent-%COMP%]{margin-bottom:15px;margin-left:0;margin-right:0;padding:0}.viaje-info-card[_ngcontent-%COMP%]{border-radius:15px;box-shadow:0 4px 6px #0000001a;background-color:#fff;width:100%}.viaje-info-card[_ngcontent-%COMP%]   h2[_ngcontent-%COMP%]{font-size:20px;margin-bottom:10px;color:var(--ion-color-tertiary);text-transform:uppercase}.viaje-info-card[_ngcontent-%COMP%]   p[_ngcontent-%COMP%]{margin:5px 0;font-size:16px;color:#333;text-transform:uppercase}ion-button[_ngcontent-%COMP%]{margin-top:10px;--border-radius: 10px}ion-button[color=primary][_ngcontent-%COMP%]{--background: #ffaa00;--border-color: #ffaa00}ion-button[color=danger][_ngcontent-%COMP%]{--color: #ff4d4f;--border-color: #ff4d4f}ion-icon[_ngcontent-%COMP%]{margin-right:8px}.map-container[_ngcontent-%COMP%]{width:100%;height:200px;border-radius:10px;margin-top:10px;background-color:#e0e0e0}"]})}}return i})()}];let U=(()=>{class i{static{this.\u0275fac=function(a){return new(a||i)}}static{this.\u0275mod=e.$C({type:i})}static{this.\u0275inj=e.G2t({imports:[m.iI.forChild(P),m.iI]})}}return i})(),C=(()=>{class i{static{this.\u0275fac=function(a){return new(a||i)}}static{this.\u0275mod=e.$C({type:i})}static{this.\u0275inj=e.G2t({imports:[d.MD,f.YN,o.bv,U]})}}return i})()}}]);